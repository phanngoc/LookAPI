openapi: 3.0.3
info:
  title: Ecommerce API
  description: |
    API documentation cho ứng dụng Ecommerce với các tính năng:
    - Authentication (Register, Login, Logout)
    - Products Management (List, Search, Detail)
    - Cart Management (Add, Update, Remove)
    - Orders Management (Checkout, History)
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.example.com/api
    description: Production server

tags:
  - name: auth
    description: Authentication endpoints
  - name: products
    description: Products management
  - name: cart
    description: Shopping cart management
  - name: orders
    description: Orders management

paths:
  /auth/register:
    post:
      tags:
        - auth
      summary: Đăng ký tài khoản mới
      description: Tạo tài khoản user mới và trả về JWT token
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterDto'
            example:
              email: user@example.com
              password: password123
              name: John Doe
      responses:
        '201':
          description: Đăng ký thành công
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                success: true
                data:
                  accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    id: 6864afd6-7cfb-4cc2-b6bc-21f13b30c2b6
                    email: user@example.com
                    name: John Doe
                    role: user
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email đã tồn tại
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags:
        - auth
      summary: Đăng nhập
      description: Xác thực user và trả về JWT token
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginDto'
            example:
              email: user@example.com
              password: password123
      responses:
        '200':
          description: Đăng nhập thành công
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Thông tin đăng nhập không đúng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      tags:
        - auth
      summary: Đăng xuất
      description: Đăng xuất user (JWT stateless, chủ yếu là client-side)
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Đăng xuất thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully

  /auth/profile:
    get:
      tags:
        - auth
      summary: Lấy thông tin user hiện tại
      description: Trả về thông tin của user đang đăng nhập
      operationId: getProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Thông tin user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /products:
    get:
      tags:
        - products
      summary: Lấy danh sách sản phẩm
      description: Lấy danh sách sản phẩm với pagination, filtering và sorting
      operationId: getProducts
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Số trang
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Số lượng items mỗi trang
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [name, price, createdAt]
            default: createdAt
          description: Trường để sort
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [ASC, DESC]
            default: DESC
          description: Thứ tự sort
        - name: categoryId
          in: query
          schema:
            type: integer
          description: Lọc theo category ID
        - name: search
          in: query
          schema:
            type: string
          description: Tìm kiếm theo tên hoặc mô tả
      responses:
        '200':
          description: Danh sách sản phẩm
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductListResponse'

  /products/search:
    get:
      tags:
        - products
      summary: Tìm kiếm sản phẩm
      description: Tìm kiếm sản phẩm theo từ khóa
      operationId: searchProducts
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Từ khóa tìm kiếm
      responses:
        '200':
          description: Kết quả tìm kiếm
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'

  /products/categories:
    get:
      tags:
        - products
      summary: Lấy danh sách categories
      description: Lấy tất cả categories
      operationId: getCategories
      responses:
        '200':
          description: Danh sách categories
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Category'

  /products/{id}:
    get:
      tags:
        - products
      summary: Lấy chi tiết sản phẩm
      description: Lấy thông tin chi tiết của một sản phẩm
      operationId: getProductById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID của sản phẩm
      responses:
        '200':
          description: Chi tiết sản phẩm
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Product'
        '404':
          $ref: '#/components/responses/NotFound'

  /cart:
    get:
      tags:
        - cart
      summary: Lấy giỏ hàng
      description: Lấy giỏ hàng của user hiện tại
      operationId: getCart
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Giỏ hàng
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - cart
      summary: Xóa toàn bộ giỏ hàng
      description: Xóa tất cả items trong giỏ hàng
      operationId: clearCart
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Xóa thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cart cleared

  /cart/items:
    post:
      tags:
        - cart
      summary: Thêm sản phẩm vào giỏ hàng
      description: Thêm sản phẩm với số lượng vào giỏ hàng
      operationId: addToCart
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddToCartDto'
            example:
              productId: 1
              quantity: 2
      responses:
        '201':
          description: Thêm thành công
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartItem'
        '400':
          description: Lỗi validation hoặc không đủ stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Không tìm thấy sản phẩm
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /cart/items/{id}:
    patch:
      tags:
        - cart
      summary: Cập nhật số lượng sản phẩm
      description: Cập nhật số lượng của một item trong giỏ hàng
      operationId: updateCartItem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID của cart item
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCartItemDto'
            example:
              quantity: 3
      responses:
        '200':
          description: Cập nhật thành công
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartItem'
        '400':
          description: Lỗi validation hoặc không đủ stock
        '404':
          description: Không tìm thấy cart item

    delete:
      tags:
        - cart
      summary: Xóa sản phẩm khỏi giỏ hàng
      description: Xóa một item khỏi giỏ hàng
      operationId: removeFromCart
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID của cart item
      responses:
        '200':
          description: Xóa thành công
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Item removed from cart
        '404':
          description: Không tìm thấy cart item

  /orders/checkout:
    post:
      tags:
        - orders
      summary: Checkout từ giỏ hàng
      description: Tạo order từ giỏ hàng, deduct inventory và clear cart
      operationId: checkout
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckoutDto'
            example:
              shippingAddress: 123 Main St, City, Country
      responses:
        '201':
          description: Checkout thành công
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '400':
          description: Giỏ hàng trống hoặc không đủ stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /orders:
    get:
      tags:
        - orders
      summary: Lấy lịch sử đơn hàng
      description: Lấy tất cả orders của user hiện tại
      operationId: getOrders
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Danh sách orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/OrderResponse'

  /orders/{id}:
    get:
      tags:
        - orders
      summary: Lấy chi tiết đơn hàng
      description: Lấy thông tin chi tiết của một order
      operationId: getOrderById
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID của order
      responses:
        '200':
          description: Chi tiết order
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/OrderResponse'
        '404':
          description: Không tìm thấy order

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token từ login/register endpoint

  schemas:
    RegisterDto:
      type: object
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          minLength: 6
          example: password123
        name:
          type: string
          example: John Doe

    LoginDto:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: password123

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            accessToken:
              type: string
              description: JWT token để sử dụng cho các protected endpoints
            user:
              $ref: '#/components/schemas/UserProfile'

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [user, admin]

    Category:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        price:
          type: number
          format: decimal
        stock:
          type: integer
        categoryId:
          type: integer
        imageUrl:
          type: string
          nullable: true
        category:
          $ref: '#/components/schemas/Category'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Product'
            meta:
              type: object
              properties:
                total:
                  type: integer
                page:
                  type: integer
                limit:
                  type: integer
                totalPages:
                  type: integer

    AddToCartDto:
      type: object
      required:
        - productId
        - quantity
      properties:
        productId:
          type: integer
          example: 1
        quantity:
          type: integer
          minimum: 1
          example: 2

    UpdateCartItemDto:
      type: object
      required:
        - quantity
      properties:
        quantity:
          type: integer
          minimum: 1
          example: 3

    CartItem:
      type: object
      properties:
        id:
          type: integer
        userId:
          type: string
          format: uuid
        productId:
          type: integer
        quantity:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CartItemResponse:
      type: object
      properties:
        id:
          type: integer
        product:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
            price:
              type: number
            imageUrl:
              type: string
            stock:
              type: integer
            category:
              $ref: '#/components/schemas/Category'
        quantity:
          type: integer
        subtotal:
          type: number

    CartResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/CartItemResponse'
            total:
              type: number
              description: Tổng tiền của giỏ hàng

    CheckoutDto:
      type: object
      required:
        - shippingAddress
      properties:
        shippingAddress:
          type: string
          example: 123 Main St, City, Country

    OrderItemResponse:
      type: object
      properties:
        id:
          type: integer
        productId:
          type: integer
        productName:
          type: string
        quantity:
          type: integer
        price:
          type: number
          description: Giá tại thời điểm order (price snapshot)
        subtotal:
          type: number

    OrderResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, confirmed, processing, shipped, delivered, cancelled]
        totalAmount:
          type: number
        shippingAddress:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemResponse'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        statusCode:
          type: integer
        timestamp:
          type: string
          format: date-time
        path:
          type: string
        message:
          type: string
          description: Thông báo lỗi

  responses:
    BadRequest:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Unauthorized - token không hợp lệ hoặc thiếu
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Không tìm thấy resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
